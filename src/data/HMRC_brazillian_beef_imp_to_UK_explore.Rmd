---
title: "Spanish cucumber imports into the UK"
output:
  pdf_document:
    latex_engine: pdflatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE)
```

#Required libraries
```{r}
require("RPostgreSQL")
library(ggplot2)
library(dplyr)
library(tidyverse)
library(lubridate)
```

#Get the HMRC auxiliary data
```{r}
source("get_HMRC_aux_data.R")
list1   <- get_HMRC_aux_data()
comcode <- data.frame(Reduce(rbind, list1[1]))
port    <- data.frame(Reduce(rbind, list1[2]))
country <- data.frame(Reduce(rbind, list1[3]))
```

#Find beef comcodes - Thank you Alex for making life nice and easy for us! 
```{r}
cc_all_beef <- comcode[grep('BEEF',  toupper(comcode$description)),]
```

#Get HMRC import data  (imports df - original column headings for comparison)
```{r}
source("get_HMRC_data_imports.R")
HMRC_EU_import_food_data_all <- get_HMRC_data_imports(imports)
(col_names               <- t(as.data.frame(colnames(HMRC_EU_import_food_data_all))))
```

#Get HMRC import data  (imports df - new column headings)
```{r}
source("get_HMRC_data_imports.R")
HMRC_EU_import_food_data <- get_HMRC_data_imports(imports)
names(HMRC_EU_import_food_data) <- c("Comcode", "Standard_International_Trade_Classification", "Record_Type", "Country_of_Dispatch_Seq", "Country_of_Dispatch", "Country_of_Origin_Seq", "Country_of_Origin", "Date", "Port_Seq", "Port", "Flag_of_Ship_Seq", "Flag_of_Ship", "Country_of_Origin_Impure_Seq", "Country_of_Origin_Impure", "Type_of_Trade", "Container", "Mode_of_Transport", "Inland_Mode_of_Transport", "Location_Seq", "Location_Alpha", "Suite_Indicator", "Procedure_Code",  "CB_Code", "Value", "Quantity_1", "Quantity_2")
(col_names               <- t(as.data.frame(colnames(HMRC_EU_import_food_data))))
```



#Select Brazillian beef import info
```{r}

HMRC_columns  <- col_names[c(1,5,8,24,25)]
HMRC_country  <- "BR"
HMRC_comcode  <- "16025095"
model_data    <- HMRC_EU_import_food_data %>% 
                 select(HMRC_columns) %>%                                                         filter(Country_of_Dispatch == HMRC_country & Comcode ==                                   HMRC_comcode) %>%
                 select(-Country_of_Dispatch, -Comcode)
```

#Clean data: Run for consistency, but no NAs, no 0000 dates and no negative values
```{r}
model_data_clean <- model_data %>% na.omit
```

#Convert period column to date format
```{r}
model_data_clean <- model_data_clean %>% 
                    mutate(Date = paste("01",Date, sep = "/")) %>%
                    mutate(Date = dmy(Date))
```

#Get the cost/kg ($/kg)
```{r}
model_data_clean <- model_data_clean %>% 
                    mutate(Cost_per_Kg = Value / Quantity_1)
```

#Aggregate data into periods of months
```{r}
model_data_group <- model_data_clean %>% group_by(Date) %>%                          
                                        summarise(Quantity_1 = sum(Quantity_1),                          
                                                  Value = sum(Value), 
                                                  Cost_per_Kg = mean(Cost_per_Kg))
```

#What does the cost/kg of the beef imported into the UK from Brazil look like over time?
```{r}
ggplot(model_data_group, aes(Date, Cost_per_Kg)) +
        geom_point() 
```

#Very high cost/kg during 2012/2013 - $150/kg seems to be a bit too exorbitant for cucumber! What does the cost/kg look like without the points above $150/kg?
```{r}
ggplot(model_data_group, aes(smk_period_reference, cost_per_kg)) + 
  geom_point() + geom_line() + ylim(0,2) + geom_smooth()
```

#What does the nett mass of the cucumber imported into the UK look like over time?
```{r}
ggplot(model_data_group, aes(smk_period_reference, smk_nett_mass)) +
        geom_point(colour = "blue") +
        geom_hline(yintercept=1E7, linetype="dashed", color = "red")
```


#Did the number of consignments also increase during the spikes? 
```{r}
ggplot(model_data_group, aes(smk_period_reference, smk_no_of_consignments)) +
        geom_line(colour = "green") +
        geom_point(colour = "green")
```

