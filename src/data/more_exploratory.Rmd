---
title: "K-means"
output:
  html_document: default
  html_notebook: default
  pdf_document:
    latex_engine: xelatex
---

# Default chunk options
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE)
```
#Required libraries
```{r}
library(RPostgreSQL)
library(tidyverse)
library(dbplyr)
library(rjson)
library(DBI)
library(lubridate)
library(tibble)
library(ggplot2)
library(stringr)
library(gridExtra)
library(network)
library(ggraph)
```
#Choose wheter to read data from file or SQL
```{r}
read_file = FALSE
```

#Get data accordingly
```{r}
if(read_file==TRUE){
source("get_Comtrade_data_all.R")
df <- get_Comtrade_data_all(201401,201601,"default","070700")
write.csv(df,'Comtrade_all.csv')
}else{
df <- read.csv(file="Comtrade_all.csv",header=TRUE)  
}
```

#Clean data
```{r}
df <- df[complete.cases(df),]
```

#Prepare data
```{r}
df2 <- df %>% filter(as.character(partner)!="World") %>% filter(as.character(partner)!="EU-27") %>%
              filter(as.character(reporter)!="World") %>% filter(as.character(reporter)!="EU-27")
df2 <- df2 %>% mutate(period_date = ymd(paste(period,"01",sep=""))) %>%
               mutate(year        = as.integer(str_sub(period,1,4))) %>%
               mutate(month       = as.integer(str_sub(period,5,6))) %>%
               mutate(price_usd_kg= trade_value_usd/netweight_kg)
Imports <- df2 %>% filter(trade_flow == "Imports") %>% select(-trade_flow)
Exports <- df2 %>% filter(trade_flow == "Exports") %>% select(-trade_flow)
```

#Get net trade data:
###Net trade weight (nwei) = Imports - Export
###Normalized net trade weight:    $\text{nval} =\frac{\text{Imports} - \text{Export}}{\text{Imports} + \text{Export}}$
###Possible cases:
####$\left|\text{nval}\right| \approx 0$: A distributor
####$\text{nval} \approx +1$: A consumer
####$\text{nval} \approx -1$: A producer
```{r}
im1 <- Imports %>% select(period_date,partner,reporter,netweight_kg,trade_value_usd)
ex1 <- Exports %>% select(period_date,partner,reporter,netweight_kg,trade_value_usd)
merged <- inner_join(im1,ex1,by=c("period_date","partner","reporter")) %>%
          rename(imp_weight = "netweight_kg.x",exp_weight = "netweight_kg.y") %>%
          rename(imp_value = "trade_value_usd.x",exp_value = "trade_value_usd.y") %>%
          mutate(Month = month(period_date),  Year = year(period_date)) %>%
          mutate(nwei   = imp_weight - exp_weight) %>%
          mutate(nval   = imp_value  - exp_value) %>%
          mutate(n_nwei = nwei/(imp_weight + exp_weight)) %>%
          mutate(n_nval = nval/(imp_value  + exp_value))
```

```{r}
guy <- "United Kingdom"
oneguy <- merged %>% filter(reporter == guy) %>% filter()
p1 <- ggplot(NULL) + geom_point(data=merged,aes(x=n_nwei,y=n_nval),size=1,alpha=0.1) +
               geom_point(data=oneguy,aes(x=n_nwei,y=n_nval),size=1,color="red") + 
               labs(x="Normalized net trade by weight",y="Normalized net trade value", title=guy)
p2 <- ggplot(NULL) + geom_histogram(data=oneguy,aes(x=n_nwei,y=..ncount..)) +
               labs(x="Normalized net trade weight",y="Count",title=guy)
grid.arrange(p1, p2, ncol=2)
```

```{r}
guy <- "Spain"
oneguy <- merged %>% filter(reporter == guy) %>% filter()
p1 <- ggplot(NULL) + geom_point(data=merged,aes(x=n_nwei,y=n_nval),size=1,alpha=0.1) +
               geom_point(data=oneguy,aes(x=n_nwei,y=n_nval),size=1,color="red") + 
               labs(x="Normalized net trade by weight",y="Normalized net trade value", title=guy)
p2 <- ggplot(NULL) + geom_histogram(data=oneguy,aes(x=n_nwei,y=..ncount..)) +
               labs(x="Normalized net trade weight",y="Count",title=guy)
grid.arrange(p1, p2, ncol=2)
```

```{r}
guy <- "Netherlands"
oneguy <- merged %>% filter(reporter == guy) %>% filter()
p1 <- ggplot(NULL) + geom_point(data=merged,aes(x=n_nwei,y=n_nval),size=1,alpha=0.1) +
               geom_point(data=oneguy,aes(x=n_nwei,y=n_nval),size=1,color="red") + 
               labs(x="Normalized net trade by weight",y="Normalized net trade value", title=guy)
p2 <- ggplot(NULL) + geom_histogram(data=oneguy,aes(x=n_nwei,y=..ncount..)) +
               labs(x="Normalized net trade weight",y="Count",title=guy)
grid.arrange(p1, p2, ncol=2)
```

#What happens here?
##How can be a net importer based on weight and exporter based on value????
##Or viceversa...
```{r}
san_che <- merged %>% select(period_date,reporter,partner,nwei,nval) %>% filter(nwei*nval<0) %>%
           mutate(ratio = nwei/nval)
ggplot(san_che) + geom_histogram(aes(x=log(abs(ratio))),bins=100)
definitively_weird <- san_che %>% filter(abs(ratio)>100)
```

#Should I use `nval' or `nwei'???
```{r}
flux <- merged %>% select(period_date,partner,reporter,nwei,nval)
flux <- flux %>%
  mutate(origin = ifelse(nval < 0,as.character(reporter),as.character(partner))) %>%
  mutate(destin = ifelse(nval > 0,as.character(reporter),as.character(partner))) %>%
  select(-partner,-reporter)
```

#Get data for the network
```{r}
netdf <- flux %>% filter(period_date == "2014-01-01") %>% select(origin,destin,nval)
```

```{r}
sources <-      netdf %>% distinct(origin) %>% rename(label = origin)
destinations <- netdf %>% distinct(destin) %>% rename(label = destin)
```
 
```{r}
nodes <- full_join(sources,destinations,by="label")
nodes <- nodes %>% rowid_to_column("id")
```

```{r}
per_route <- netdf %>% group_by(origin,destin) %>% summarise(weight = abs(sum(nval))/1e6) %>%  ungroup()
#per_route <- netdf %>% group_by(origin,destin) %>% summarise(weight = n()) %>%  ungroup()
(max(per_route$weight))
```

```{r}
edges <- per_route %>% left_join(nodes,by=c("origin" = "label")) %>% rename(from = id)
edges <- edges     %>% left_join(nodes,by=c("destin" = "label")) %>% rename(to   = id)
```

```{r}
edges <- select(edges,from,to,weight)
```

```{r}
routes_network <- network(edges,vertex.attr = nodes, matrix.type="edgelist",ignore.eval=FALSE)
routes_network
```
```{r}
plot(routes_network,vertex.cex = 2)
```
```{r}
library(visNetwork)
library(networkD3)
```

```{r}
visNetwork(nodes,edges)
```

```{r}
edges <- mutate(edges, width = weight/5 + 1)
```

```{r}
visNetwork(nodes, edges) %>% 
  visIgraphLayout(layout = "layout_with_fr") %>% 
  visEdges(arrows = "middle")
```
```{r}
nodes_d3 <- mutate(nodes, id = id - 1)
edges_d3 <- mutate(edges, from = from - 1, to = to - 1)
```

```{r}
forceNetwork(Links = edges_d3, Nodes = nodes_d3, Source = "from", Target = "to", 
             NodeID = "label", Group = "id", Value = "weight", 
             opacity = 1, fontSize = 16, zoom = TRUE)
```

```{r}
sankeyNetwork(Links = edges_d3, Nodes = nodes_d3, Source = "from", Target = "to", 
              NodeID = "label", Value = "weight", fontSize = 16, unit = "Letter(s)")
```